<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minimalist Reader</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Courier+Prime&display=swap">



<style>

:root {
    --UIheight: 50px;
    --darkblue: rgb(12, 12, 42);
    --darkred: rgb(42, 12, 12);
    --lightblue: rgba(200,200,255,1);
    --lightred: rgba(255,200,200,1);
    --textmargin: 50px;
    --FooterHeight: 200px;
}
body {
    background-color:gainsboro;
}
p {
    font-size: 1rem;
    text-align: justify;
    margin-top:0;
    margin-bottom:0;
}

div.Header {
    position:absolute;
    left:50%;
    top:0;
    transform: translateX(-50%);
    height: var(--UIheight);
    width:100%;
}
div.Display {
    position:absolute;
    left:50vw;
    top: var(--UIheight);
    transform: translateX(-50vw);
    height: calc( 90dvh - var(--UIheight) );
    width: 100%;
}

div.bodytext { 
    padding-left: var(--textmargin);
    padding-right: var(--textmargin);
}
div.style1 {
    background-color: var(--darkblue);
    color: var(--lightblue);    
    
}
div.style2 {
    background-color: var(--darkred);
    color: var(--lightred);
}

div.Footer {
    position:fixed;
    background-color: white;
    width:100%;
    height:var(--FooterHeight);
    top: calc( 100dvh - var(--FooterHeight) );
    left:50%;
    transform: translateX(-50%);
}
div.ToggleTOC {
    font-family: Arial, Helvetica, sans-serif;
    position:absolute;
    font-size: 15vw;
    margin:0;
    padding:0;
    bottom:0;
    line-height:0.5em;
    font-weight: bolder;
    left:50%;
    transform: translateX(-50%) scaleX(500%);
    width:100%;
    height:80px;
    text-align: center;
}
div.Header {
    width:100vw;
    height:40px;
    display: grid;
    grid-template-columns: auto auto auto auto auto auto;
    text-align: center;

}
div.Header > div {
    flex: 1;
}
img.Icon {
    height:40px;
    width: auto;
    cursor: pointer;
}

</style>
</head>
<body>

<div class="Display TableOfContents">
    <p>Fusce molestie aliquam mauris, in semper leo sodales et. In sed pharetra massa, ac lacinia metus. Sed quis odio orci. Mauris eu tristique enim. Sed at velit in mauris venenatis semper vel ac lacus. Class aptent taciti sociosqu ad litora torquent per conubia nostra, per inceptos himenaeos. Nulla elementum, ante id sodales iaculis, felis mi aliquam dolor, sit amet fringilla dolor justo at urna. Fusce eu sem id augue pellentesque vestibulum vel eu quam.
    </p>
</div>

<div class="Display Binder" id="BINDER">
    <div class="bodytext style1"><p>Fusce molestie aliquam mauris, in semper leo sodales et. In sed pharetra massa, ac lacinia metus. Sed quis odio orci. Mauris eu tristique enim. Sed at velit in mauris venenatis semper vel ac lacus. Class aptent taciti sociosqu ad litora torquent per conubia nostra, per inceptos himenaeos. Nulla elementum, ante id sodales iaculis, felis mi aliquam dolor, sit amet fringilla dolor justo at urna. Fusce eu sem id augue pellentesque vestibulum vel eu quam.
    </p></div>
    <div class="bodytext style2"><p>Pellentesque fringilla tincidunt odio eget posuere. Sed maximus cursus nibh vitae congue. Etiam dapibus lobortis purus vitae volutpat. Sed vel risus ut massa gravida laoreet at at leo. Ut viverra neque a tellus suscipit luctus. Aliquam ultrices cursus neque, id posuere dolor pretium quis. Morbi efficitur tellus sed imperdiet imperdiet. Donec porttitor ante mauris, id sodales odio volutpat consequat. Proin sit amet quam eget nulla bibendum tincidunt vel vitae metus. Aenean in fringilla urna, eu pharetra sem. In et dictum neque. Donec finibus velit ac erat sagittis suscipit. Nam posuere dignissim dolor at faucibus.
    </p></div>
    <div class="bodytext style1"><p>Cras efficitur tempus auctor. Aenean elementum suscipit tellus, vel aliquet lorem lacinia sit amet. Vestibulum ante ipsum primis in faucibus orci luctus et ultrices posuere cubilia curae; Nam quis purus vitae leo sodales iaculis. Praesent tortor libero, vehicula sit amet eleifend non, finibus sit amet est. Vivamus ullamcorper massa in sapien commodo euismod. Donec dictum diam mollis, molestie nibh sit amet, iaculis nisi. Donec urna quam, sodales eu aliquet sed, tincidunt vel dui. Donec vitae convallis tortor. Suspendisse rhoncus tortor vitae augue blandit, at lacinia justo faucibus. Nulla tincidunt faucibus velit, finibus tincidunt purus venenatis sed.
    </p></div>
    <div class="bodytext style2"><p>Vestibulum consectetur accumsan lorem, nec sollicitudin lorem ornare sed. Vivamus sit amet nisi nisi. Nam ac diam vestibulum, interdum orci tincidunt, lobortis ex. Sed ut rhoncus mauris. Fusce semper ligula vitae risus pulvinar, efficitur placerat tortor convallis. Suspendisse tincidunt commodo orci, sed posuere purus fermentum vitae. Pellentesque hendrerit fringilla laoreet. Phasellus interdum nunc massa, sed ultricies ligula consectetur ut. Fusce rutrum eget velit ut rutrum. Aenean sit amet magna at urna sodales suscipit. Etiam cursus ipsum eget eros ullamcorper, sed tristique nisi congue. Donec mollis congue nisl, viverra iaculis metus blandit eget. Etiam mattis gravida molestie. Quisque sagittis, eros nec malesuada viverra, eros lorem porttitor ligula, in tincidunt nisi nisi pretium ipsum.
    </p></div>
    <div class="bodytext style1"><p>Ut bibendum mattis felis, lacinia gravida libero mattis at. Aliquam non volutpat diam. Pellentesque vitae suscipit ex. Sed eget risus in est venenatis vulputate. Curabitur non venenatis risus. Vivamus sollicitudin velit eget tortor pellentesque sodales. Donec orci tortor, posuere quis tellus in, mollis tincidunt tortor. Quisque sed orci eget elit iaculis sollicitudin sit amet sed eros. Phasellus semper vestibulum risus eu iaculis. Aliquam erat volutpat. Integer luctus cursus eros. Fusce blandit iaculis ex vitae ultricies. Praesent quam ipsum, hendrerit sit amet fringilla a, feugiat vel libero. 
    </p></div>
</div>

<div class="Header" id="HEADER">
    <div id="ICON-ONEPAGE" onclick="buttonContinuous();"><img class="Icon" title="Continuous Scrolling" src="https://autononymous.io/wp-content/uploads/2025/05/fbicon-Extend.png" alt="&#8853;"></div>
    <div id="ICON-LINEDN" onclick="buttonLineSpace(1);SaveSettings();"><img class="Icon" title="Increase Line Spacing" src="https://autononymous.io/wp-content/uploads/2025/05/fbicon-LineDn.png" alt="&#8853;"></div>
    <div id="ICON-LINEUP" onclick="buttonLineSpace(-1);SaveSettings();"><img class="Icon" title="Decrease Line Spacing" src="https://autononymous.io/wp-content/uploads/2025/05/fbicon-LineUp.png" alt="&#8854;"></div>
    <div id="ICON-FONTUP" onclick="buttonFontSize(1);SaveSettings();"><img class="Icon" title="Increase Font Size"" src="https://autononymous.io/wp-content/uploads/2025/05/fbicon-Larger.png" alt="&#8853;"></div>
    <div id="ICON-FONTDN" onclick="buttonFontSize(-1);SaveSettings();"><img class="Icon" title="Decrease Font Size" src="https://autononymous.io/wp-content/uploads/2025/05/fbicon-Smaller.png" alt="&#8854;"></div>
    <div id="ICON-THEME" onclick="buttonSetTheme(1);SaveSettings();"><img class="Icon" title="Change Theme" src="https://cdn-icons-png.flaticon.com/512/11072/11072905.png"></div>

</div>

<div class="Footer" id="FOOTER">
    <div class="ProgressBar"></div>
    <div class="ToggleTOC" onclick="StateTOC();"><span>&or;</span></div>
</div>
<script>

// Defined Elements
const eFOOTER = document.getElementById('FOOTER');
const eBINDER = document.getElementById('BINDER');
var eTARGET = "";
var vFOOTER = 0;

// Constant Variables
const SourceROOT = "https://raw.githubusercontent.com/autononymous/autononymous.github.io/master/WebnovelReader/"
const SourceFILE = SourceROOT + "/docs/PG00.json";
const SourceTOC = SourceROOT + "/docs/PG00TOC.json";
const vPageTol = 50;

// Operational Variables
var jTEXT = "";
var ShowTOC = false;
var CONTENT = [];

var DebugText = "";

var Current = JSON.parse(`{"Chapter":0,"Page":0}`);
var Max = JSON.parse(`{"Chapter":0,"Page":0}`);
var Min = JSON.parse(`{"Chapter":0,"Page":0}`);

// Functions

async function fetchJSON() {
    try {
        const response = await fetch(SourceFILE);
        if (!response.ok) {
            throw new Error('Network response for JSON was not ok ' + response.statusText);
        }
        const data = await response.text();
        return JSON.parse(data.replaceAll(/(\r\n|\n|\r)/gm, ''));
    } catch (error) {
        console.error('Error fetching the file:', error);
    }
}

async function fetchTOC() {
    try {
        const response = await fetch(SourceTOC);
        if (!response.ok) {
            throw new Error('Network response for TOC JSON was not ok ' + response.statusText);
        }
        const data = await response.text();
        return JSON.parse(data.replaceAll(/(\r\n|\n|\r)/gm, ''));
    } catch (error) {
        console.error("Unable to load the TOC JSON file.")
    }
}
async function Initialize() {
    jTEXT   = await fetchJSON();
    jTOC    = await fetchTOC();
    console.debug(jTEXT);
    await TextBuilder();
    await TextDeployer(6);
    console.log(DebugText);DebugText="";
}



function StateTOC(state) {
    if(state) {
        ShowTOC = state;
    } else {
        ShowTOC = !ShowTOC;
    }
    
    if (ShowTOC) {
        eBINDER.style.top = "110vh";
    } else {
        eBINDER.style.removeProperty("top");
    }
}

async function TextBuilder() {

    let ContentIndex = 0;

    jTEXT.Manuscript.forEach ( parcel => {
        // Define what we're getting.
        let pTitle      = (parcel.ChapterOverride=="") ? parcel.AutoNameFull : parcel.ChapterOverride;
        let pSubtitle   = parcel.GivenName;
        let pContent    = parcel.Body;
        let pID         = (parcel.VerboseOverride=="") ? parcel.VerboseID : parcel.VerboseOverride;
        let pSynopsis   = parcel.Synopsis;
        let pType       = parcel.DocType;
        let pStyle      = parcel.Perspective;
        let pSceneNum   = parcel.ScenePart;

        switch(pType) {
            case "Chapter":
                CONTENT.push([
                    '#STYLE#', 
                     pStyle, 
                    '%CHP%', 
                     pTitle, 
                    '%SUB%', 
                     pSubtitle
                ]);
                break;
            case "Scene":
                let Lines = pContent
                    .replaceAll('<p>','\n')
                    .replaceAll('</p>','')
                    .split('\n');
                let Words = [];
                Lines.forEach (Line => {
                    Line.split(' ').forEach(Word => {
                        if(Word != "") {Words.push(Word);}
                    });                    
                    Words.push('#BRK#');
                });
                CONTENT[CONTENT.length-1].push(
                    '#STYLE#', 
                     pStyle, 
                    '%SEC%',
                     pSceneNum,
                    '%SCN%'
                );
                Words.forEach( Word => {
                    CONTENT[CONTENT.length-1].push(Word);
                })
                break;            
        }
    });
    // Now get the characteristics of the loaded data.
    Min.Chapter = 0;
    Max.Chapter = CONTENT.length;


}

async function TextDeployer(ChapterNum) {
    let LoadedChapter = 0;
    if(ChapterNum) {
        LoadedChapter = (ChapterNum < Max.Chapter) ? ((ChapterNum >= 0) ? ChapterNum : Min.Chapter ) : Max.Chapter;
    }

    //DBG// console.debug(`Min=${Min.Chapter}, \nMax=${Max.Chapter},\nPrompted=${ChapterNum},\nLoaded=${LoadedChapter}`)


    // Get characteristics of the page where text will be loaded.
    let vFOOTER = eFOOTER.getBoundingClientRect().top;

    // Define Trackers
    let tStyle = undefined;
    let tElement = undefined;

    // Define Reading States
    let rElem = false;

    eBINDER.innerHTML = "";
    eBINDER.innerHTML += `<div id="PAGE0"></div>`;
    eTARGET = document.getElementById('PAGE0');
    Current.Page = 0;

    CONTENT[LoadedChapter].forEach( token => {
        if (rElem) {
            tStyle = token;
            console.debug(tStyle);
            rElem = false;
        }
        switch (token) {
            case '#STYLE#':
                rElem = true;
                break;
            case '#BRK#':
                eTARGET.innerHTML += "<br>";
                break;
            case '%CHP%':
                break;
            case '%SUB%':
                break;
            case '%SEC%':
                break;
            case '%SCN%':
                break;
            default:
                AdvanceText(" " + token);
                break;
        }
    });
    
    DebugText += `\n > Chapter ${LoadedChapter+1} loaded.`;

}

function AdvanceText(text) {
    let LastState = eTARGET.innerHTML + "";
    eTARGET.innerHTML += text;
    let PageDistance = (vFOOTER + vPageTol) - eTARGET.getBoundingClientRect().bottom
    //console.debug(` ${vFOOTER} + ${vPageTol} - ${eTARGET.getBoundingClientRect().bottom} = ${PageDistance}`);
    if ( (vFOOTER + vPageTol) < eTARGET.getBoundingClientRect().bottom ) {
        eTARGET.innerHTML = LastState;
        Current.Page++;
        eBINDER.innerHTML += `<div id="PAGE${Current.Page}""></div>`;
        eTARGET.style.display = "none";
        eTARGET = document.getElementById(`PAGE${Current.Page}`);
        eTARGET.innerHTML += text;
    }
}



Initialize();


</script>
</body>
</html>