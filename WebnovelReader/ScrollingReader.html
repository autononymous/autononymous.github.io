<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PARAGATE Reader</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bellefair&family=Caveat:wght@400..700&family=Cormorant+Infant:ital,wght@0,300..700;1,300..700&family=Cormorant+Unicase:wght@300;400;500;600;700&family=Montez&family=Oxanium:wght@200..800&family=Patrick+Hand+SC&family=Quintessential&family=Roboto+Condensed:ital,wght@0,100..900;1,100..900&family=Roboto+Flex:opsz,wght@8..144,100..1000&display=swap" rel="stylesheet">

</head>

<style>
    :root {

    --MenuHeight: 50px;

    --TextSetWidthFixed: 40px;
    --TextSetWidthDynamic: 10vw;
    --TextSize: 1.5em;
    --TextLineHeight: 1.5em;
    --TextMargin: 5vw;
    --DefaultWidth: 600px;

    --CodyTitle:"Oxanium", sans-serif, "Bahnscrift",'Arial';
    --CodyText:"Roboto Flex", sans-serif, 'Bahnschrift', 'Arial';
    --CodySize: calc( var(--TextSize) - 0.10em );

    --KatiyaTitle: "Cormorant Unicase", serif;
    --KatiyaText:'Cormorant Infant', serif, 'Lucida Fax', 'Times New Roman';
    --KatiyaSize: calc(var(--TextSize) + 0.00em );

    --TitusTitle: "Cormorant Unicase", serif;
    --TitusText:'Cormorant Infant', serif, 'Lucida Fax', 'Times New Roman';
    --TitusSize: calc(var(--TextSize) + 0.00em );
        
    --CoverParagate: 
        radial-gradient(
            rgba(128,128,128,0.8), 
            rgba(128,128,128,0.4)
            ), 
        linear-gradient(
            to right, 
            rgba(255, 64, 64, 0.5),
            rgba(64,64,255,0.5)
            );
    --CoverFirebrand:
        radial-gradient(
            rgba(243, 229, 83, 0.6), 
            rgba(245, 72, 72, 0.3)
            ), 
        linear-gradient(
            to right, 
            rgba(237, 28, 28, 0.3),
            rgba(195,144,212,0.6),
            rgba(237, 28, 28, 0.3)
            );
    --CoverGradient:  var(--CoverParagate);

    --WallCody: url("design/bg-cody.jpg");
    --WallKat:  url("design/bg-kat.jpg");
    --WallTie:  url("design/bg-tie.jpeg");

    --ActiveTitle: var(--CodyTitle);
    --ActiveSub: var(--CodyText);
    --ActiveSize: var(--CodySize);

    --ActivePrimary: 189, 0, 28;
    --ActiveSecondary: 156, 121, 33;
    --TOCEntryHeight:   80px;
    --TOCbackground: rgba(0,0,0,0.1);

    --TextColor: black;
    --BackgroundColor: white;
    --HoverColor: rgba(12,12,12,0.1);
    --BarColor: black;
    --IconState: invert(1);

    --CodyOp: 1;
    --KatOp:  1;
    --TieOp:  1;

    --Title: 2.5em;
    --Subtitle: 2.0em;
    --Section: 2.5em;

    --SubtitleAccent: '  ';
    --SectionAccent: ' - ';

    --MsgFont: "SanFrancisco",'Helvetica Neue','Helvetica';
    --MsgColorTo: rgba(33, 138, 255, 0.8);
    --MsgFontColorTo: white;
    --MsgColorFrom: rgba(216, 216, 216, 0.8);
    --MsgFontColorFrom: black;
     


    }

    body {
        overflow:hidden;
        background-color: var(--BackgroundColor);/**/
        background-image: url("design/bg-cody.png");
    }
    div {
        border: none;/*1px solid black;*/
    }

    .Cody {
        color: var(--TextColor);
    }
    p.Cody {
        font-size: var(--CodySize);
        line-height: var(--TextLineHeight);
        text-align: justify;
        font-family: var(--CodyText);
        font-weight:300;
    }    
    h3.Cody {
        font-family: var(--CodyTitle);
    }

    h3 {
        text-align: center;
    }
    h3.Title {
        font-size: var(--Title);
        color: var(--TextColor);
        text-decoration: underline;
    }
    h3.Subtitle {
        font-size: var(--Subtitle);
        color: var(--TextColor);
    }
    h3.Section {
        font-size: var(--Section);
        color: var(--TextColor);
    }
    h3.Section::before{
        content:var(--SectionAccent);
    }
    h3.Section::after{
        content:var(--SectionAccent);
    }

    .Katiya {
        color: var(--TextColor);
    }
    p.Katiya {
        font-family: var(--KatiyaText);
        font-size: var(--KatiyaSize);
        font-weight:500;
        line-height: var(--TextLineHeight);
        text-align: justify;
    }
    h3.Katiya {
        font-family: var(--KatiyaTitle);
    }

    .Titus {
        color: var(--TextColor);
    }
    p.Titus {
        font-family: var(--KatiyaText);
        font-size: var(--KatiyaSize);
        font-weight:500;
        line-height: var(--TextLineHeight);
        text-align: justify;
    }
    
    h3.Titus {
        font-family: var(--KatiyaTitle);
    }



    p.TitusHand {
        background-image:
            linear-gradient(
                rgba(255, 210, 205, 0.8)
            ),
            var(--WallTie);
    }
    span.TitusHand {
        font-family: "Caveat", cursive;
        color: rgb(133, 3, 3);
        box-shadow: 0px 0px 8px 2px var(--TextColor);
        border: 2px solid var(--BackgroundColor);

    }
    p.CodyHand {
        background-image:
            linear-gradient(
                rgba(201, 232, 255, 0.8)
            ),
            var(--WallCody);
        mix-blend-mode: hard-light;
        box-shadow: 0px 0px 8px 2px var(--TextColor);
        border: 2px solid var(--BackgroundColor);
    }
    span.CodyHand {
        font-family: "Patrick Hand SC", cursive;
        color: rgb(0, 0, 43);
    }
    p.KatiyaHand {
        background-image:
            linear-gradient(
                rgba(255, 242, 214, 0.8)
            ),
            var(--WallKat);
        box-shadow: 0px 0px 8px 2px var(--TextColor);
        border: 2px solid var(--BackgroundColor);
    }
    span.KatiyaHand {
        font-family: "Montez", cursive;
        color: rgb(22, 16, 10);
    }







    div.imgbg {
        position:absolute;
        top:0;
        left:0;
        width:100vw;
        height:100vh;
    }
    div.codybg {
        background-image:             
            linear-gradient(
                to right, 
                rgba(128,128,128,0.20) 0%,
                rgba(128,128,128,0.90) min(calc(100vw - var(--DefaultWidth) - 100px ), calc(var(--TextMargin) / 2)), 
                rgba(128,128,128,0.90) max(var(--DefaultWidth) + 100px, 100% - calc( var(--TextMargin) / 2)), 
                rgba(128,128,128,0.20) 100%
            ),
            var(--WallCody);
        opacity: var(--CodyOp); 
        filter: var(--IconState);
        mix-blend-mode: hard-light;
    }
    div.katbg {
        background-image:             
            linear-gradient(
                to right, 
                rgba(128,128,128,0.20) 0%,
                rgba(128,128,128,0.92) min(calc(100vw - var(--DefaultWidth) - 100px ), calc(var(--TextMargin) / 2)), 
                rgba(128,128,128,0.92) max(var(--DefaultWidth) + 100px, 100% - calc( var(--TextMargin) / 2)), 
                rgba(128,128,128,0.20) 100%
            ),
            var(--WallKat);
        opacity: var(--KatOp);            
        filter: var(--IconState);
        mix-blend-mode:hard-light;
    }

    div.tiebg {
        background-image:             
            linear-gradient(
                to right, 
                rgba(50,50,50,0.60) 0%,
                rgba(128,128,128,0.96) min(calc(100vw - var(--DefaultWidth) - 100px ), calc(var(--TextMargin) / 2)), 
                rgba(128,128,128,0.96) max(var(--DefaultWidth) + 100px, 100% - calc( var(--TextMargin) / 2)), 
                rgba(50,50,50,0.60) 100%
            ),
            var(--WallTie);
        opacity: var(--TieOp);            
        filter: var(--IconState);
        mix-blend-mode:hard-light;
    }

    div.FullContainer {
        display: grid;
        grid-template:
            'leftmargin header header header rightmargin'
            'leftmargin body body body rightmargin'
            'leftmargin footer footer footer rightmargin';
        grid-column-gap: 0px;
        grid-row-gap: 0px;
        position:absolute;
        width:100vw;
        height:100dvh;
        left:-50vw;
        top:0;
        transform: translateX(50vw);
        overflow:hidden;
        /*background-color: var(--BackgroundColor)*/
    } 
    div.Gutter {
        width: max(calc((100vw - var(--DefaultWidth))/2),var(--TextMargin))
    }
    .ContainerLeft   { 
        grid-area: leftmargin;
        /*background-color: var(--BackgroundColor);*/
    }
    .ContainerRight  { 
        grid-area: rightmargin;
        /*background-color: var(--BackgroundColor);*/
    }
    .ContainerHead   { 
        background-color: var(--BackgroundColor);
        grid-area: header;
        height:var(--MenuHeight);        
        width:auto;
        display: grid;
        grid-template-columns: auto auto auto auto auto;
        text-align: center;
    }
        img.Icon {
            position:relative;
            top:10px;
            height:40px;
            width: auto;
            cursor: pointer;        
            filter: drop-shadow(0 1000px 0 var(--TextColor));
            transform: translateY(-1000px);
            
        }    
    .ContainerBody   { 
        grid-area: body;
        height: calc(100dvh - 100px - min(35vw,120px));
        width: min(var(--DefaultWidth), calc( 100vw - (var(--TextMargin) / 2) ));
        overflow-x: hidden;
        overflow-y: scroll;
        scrollbar-width: none;
        /*background-color: var(--BackgroundColor);/**/
    }
    .ContainerFooter {
        grid-area: footer;
        display: inline-flex;
        flex-direction: column;
        height:min(35vw,120px);
    }
        .FooterProgress {
            height:min(10vw,20px);
            background-color: var(--BackgroundColor);/**/
        }
            .ProgressBar {
                position:relative;
                top: min(2vw,2px);
                left: 0; /**/
                width:0px; /**/
                height: min(6vw,14px);
                background-color: var(--BarColor);
            }
        .FooterInfo {             
            height:min(25vw,100px);
            width:100%;
            display: inline-flex;
            flex-direction: row;
        }
            .Footer-Left {
                width:min(25vw,100px);
                font-size: min(30vw,120px);
                line-height: 0;
                cursor:pointer;
                color: var(--BarColor);
            }
            .Footer-Center {
                width: calc( 100% - min(50vw,200px) );
                pointer-events: none;
            }
                .FooterContent {                
                    color: var(--BarColor);
                    text-align: center;                
                    line-height:1em;
                    position:relative;
                    left:50%;
                    top:50%;
                    transform: translate(-50%,-50%);                
                    transition: linear 0.2s;
                }
                .FooterContent > p {
                    padding:0;
                    margin:0;
                }
                
                .FooterContent:hover {
                    color: gray;
                    cursor:help;
                    border: 1px solid gray;
                    border-radius: 5px;
                    transition: linear 0.2s;
                }
            .InfoTitle {
                padding:0;
                margin:0;
                line-height:1em;
                font-family: var(--ActiveTitle);
                font-size: var(--ActiveSize);
            }
            .InfoSub {
                font-family: var(--ActiveSub);
                font-size: var(--ActiveSize);
            }
            .Footer-Right {
                width: min(25vw,100px);
                font-size: min(30vw,120px);
                line-height: 0;   
                cursor:pointer;    
                color: var(--BarColor);
                
            }
    div.Page {
        position:relative;
        left: min(var(--TextSetWidthFixed), var(--TextSetWidthDynamic));
        width:max(calc(100% - (var(--TextSetWidthFixed)*2)), calc(100% - (var(--TextSetWidthDynamic)*2)));
        padding-bottom: 50dvh; /*calc(50dvh - 100px - min(35vw,120px));*/
    }
        div.EndSpacer {
            height:100vw;
        }
    div.Centered {
        position: relative;
        left:50%;
        top:min(10vw,35px);
        transform: translate(-50%,-50%);
        text-align: center;
        pointer-events: none;
    }    
    div.Cover {
        position: fixed;
        left:max(calc((100vw - 600px)/2),var(--TextMargin));
        top:var(--MenuHeight);
        width:min(600px, calc( 100vw - (var(--TextMargin) / 2) ));
        height:calc(100dvh - var(--MenuHeight) - min(35vw,120px));
        pointer-events: none;
        background-image: 
            linear-gradient(
                to bottom,
                var(--BackgroundColor) 3%,
                transparent 8%,
                transparent 92%,
                var(--BackgroundColor) 97%
            )
    }
    
    @media only screen and (max-width: 700px) {
        div.FullContainer {
            grid-template:
                'header header header'
                'leftmargin body rightmargin'
                'footer footer footer';
        }
        div.Gutter {
            width:0px;
        }
        div.ContainerBody {
            width:100%;
        }
        div.Cover {
            left:0;
            width:100%;
        }
    }

p.CodyHand, p.KatiyaHand, p.TitusHand {
    margin:20px;
    padding: 10px;
    border-radius: 3px;
    text-align: left;
}
.CodyHand, .KatiyaHand, .TitusHand {
    text-align: left;
}


p.msgfrom {
    font-family: var(--MsgFont);
    text-indent: 0;
    line-height:1.5rem;
    padding: 10px;
    padding-left:20px;
    margin-top: 10px;
    margin-bottom: 10px;
    margin-left:0;
    margin-right:0;
    text-align: left;
    border: 0px solid var(--TextColor);
    border-radius: 10px 10px 10px 0px;
    position: relative;
    width: fit-content;
    max-width: 350px;
    background-image: linear-gradient(var(--MsgColorFrom));
    color: var(--MsgFontColorFrom);
}
p.msgfrom::before {
  width: 10px;
  height: 10px;
  background-image: linear-gradient(-45deg,var(--MsgColorFrom) 50%,transparent 50%);
  position: absolute;
  left: -10px;
  bottom: 0;
  content: "";
}

p.msgto {
    font-family: var(--MsgFont);
    text-indent: 0;
    line-height:1.5rem;
    padding: 10px;
    padding-right:20px;
    margin-top: 10px;
    margin-bottom: 10px;
    margin-left:0;
    margin-right:0;
    text-align: right;
    border: 0px solid var(--TextColor);
    border-radius: 10px 10px 0px 10px;
    position: relative;
    width: fit-content;
    right: -100%;
    transform: translateX(-100%);
    max-width: 350px;
    background-image: linear-gradient(var(--MsgColorTo));
    color: var(--MsgFontColorTo);
}
p.msgto::before {
  width: 10px;
  height: 10px;
  background-image: linear-gradient(45deg,var(--MsgColorTo) 50%,transparent 50%);
  position: absolute;
  right: -10px;
  bottom: 0;
  content: "";
}

span.msgfromdate {    
    font-size: 0.6em;
    font-style: italic;
}
span.msgfrom {
    font-size: 1.25rem;
    word-wrap: break-word;
    line-height: 1.25;
}
span.msgtodate {    
    font-size: 0.6em;  
    font-style: italic;  
}
span.msgto {
    font-size: 1.25rem;
    word-wrap: break-word;
    line-height: 1.25;
}





div.TOC {
    width:100%;
    height:100%;
    color: var(--TextColor);/*rgba(var(--ActivePrimary),1);*/
}
div.Table {
    display:inline-flex;
    flex-direction: column;
    text-align: center;
    vertical-align: center;
    overflow-y: scroll;
    scrollbar-width: none;
}
div.Act {
    width:100%;
    height:auto;
    display:inline-flex;
    flex-direction: column;
}
div.ActRow {
    width:100%;
    height: 40px;
    /*background-color: rgba(var(--ColorPrimary),0.1);*/
    font-family: var(--ActiveTitle);
    font-size: 2em;
    text-align: center;
    border-top:2px solid rgba(var(--TextColor),1);
    border-bottom: 2px solid rgba(var(--TextColor),1);
    box-shadow: 0px 0px 15px 3px rgba(0,0,0,0.5);
}
div.ChapterSet {
    overflow:hidden;
    height:auto;
}
div.ChapterRow {
    display: inline-flex;
    flex-direction: row;
    height: var(--TOCEntryHeight);
    justify-items: left;
}
@keyframes flasherror {
    0% {
        background-color: transparent;
    } 
    30% {
        background-color: rgba(237, 146, 146, 0.3);
    }
    70% {
        background-color: rgba(237, 146, 146, 0.3);
    }
    100% {
        background-color: transparent;
    }
}

@keyframes slide-up {
    0% {
        opacity:1;  
        top: 0;
        pointer-events: all;
    } 
    60% {
        top: -110vh;
        pointer-events: none;
        opacity:0;  
    }
    100% {
        top: -110vh;
        opacity:0;  
    }
}
@keyframes slide-down {
    0% {
        opacity:0;  
        top: -110vh;
        pointer-events: all;
    } 
    60% {
        top: 0;
        pointer-events: none;
        opacity:1;  
    }
    100% {
        top: 0;
        opacity:1;  
    }
}
@keyframes fadein {
    0% {
        opacity:0;  
        pointer-events: none;
    } 
    40% {
        pointer-events: all;
        opacity:0;  
    }
    100% {
        opacity:1;  
    }
}
@keyframes fadeout {
    0% {
        opacity:1;
        pointer-events: all;
    } 
    40% {
        pointer-events: none;
        opacity:0;  
    }
    100% {
        opacity:0;  
    }
}

div.activerow {
    transition: background-color 0.3s ease-in-out 0.05s;
}
div.activerow:hover {
    background-color: var(--HoverColor)
}
div.inactiverow {
    transition: background-color 0.3s ease-in-out 0.05s;
    background-color: rgba(128,128,128,0.15);
}
div.inactiverow:hover {
    background-color: rgba(255,50,50,0.15);
}
div.newrow {
    background-color: rgba(180,180,40,0.15);
}
div.newrow::after {
    color: var(--TextColor);
    font-family: var(--ActiveTitle);
    content:"New!";
    position:relative;
    right:20px;
    top:50%;
    transform: translateY(-50%);
    border:1px solid var(--BarColor);
    border-radius: 3px;
    height:20px;
    width: 60px;
    text-align: center;
}

div.TOCmarker {
  position: relative;
  height: 12px;
  width: 12px;
  background-color: none;
  border: 1px solid var(--TextColor);/*rgba(var(--ActivePrimary),1);*/
  border-radius: 50%;
  margin-left: calc(4vw + 3px);
  transform: translate(-50%,0);
  margin-top: calc( (var(--TOCEntryHeight)/2) - 9px);
}
@media only screen and (max-width: 700px) {
    div.TOCmain {
        grid-template:
            'tocgutter tocbody tocgutter'
            'tocfooter tocfooter tocfooter';
    }
}

div.TOCmain {
    position:absolute;
    left:50vw;
    top:0;
    transform: translateX(-50%);
    width: min(600px, 100vw);/*calc( 100vw - (var(--TextMargin) / 2) ));*/
    height: calc(100dvh - 120px);
    position: absolute;
    overflow-y:scroll;    
    scrollbar-width: none;
    background: var(--TOCbackground);
    opacity:0;
}   

div.FloatName {
    position:absolute;
    bottom: 15px;
    left: 50vw;
    transform: translateX(-50%)
}

div.AuthorTitle {
    position:absolute;
    bottom:12px;
    left:50%;
    transform:translateX(-50%);
}
div.AuthorTitle:hover {
    filter:invert(0.2);
    transition: linear 0.2s;
}
img.AuthorTitle {
    height:15px;
    filter: drop-shadow(0 -100px 0px var(--BarColor));    
    transform:translateY(100px);
}

div.ChapterState {
    margin-left: 4vw;
    margin-right:2vw;
    position: relative;
    background-color: var(--TextColor);/*rgba(var(--ActivePrimary),1);*/
    width: 4px;
    top: 0;
    height: 100%;
    /*transform: translate(0%, -50%);*/
    left: calc(-4vw - 15px);
}

div.ChapterNumber {
    width:40px;
    font-size: 2.0em;
    padding-right:2px;
    text-align: left;
    font-family: var(--ActiveTitle);
    margin-top:25px;
    transform: translate(-50%,0);
}
div.ChapterDescription {
    max-width:80vw;
    flex:5;
    display: inline-flex;
    flex-direction: column;
    position: relative;
    left: -10px;
    border-left: 1px dashed var(--BarColor);/*rgba(var(--ActivePrimary),;*/
    padding-left: 15px;
    font-weight: 500;
}
div.ChapterName {
    flex:1;
    height:30px;
    text-align: left;
    font-size: 1.2em;
    font-family: var(--ActiveTitle);
    white-space: nowrap;
    margin-top:5px;
}
div.ChapterSynopsis {
    flex:4;
    text-align: left;
    text-emphasis: italic;
    font-size:0.8em;
    opacity:0.6;
    font-family: var(--ActiveSub);
    overflow-y: hidden;
    margin-bottom:5px;
}
div.ChapterDate {  
    position:relative;
    transform: rotate(-90deg) translate(-5px,calc(4vw + 25px));
    width: 20px;
    opacity:0.3;
}



div.CoverAnnounce {
    position:absolute;
    left:50vw;
    top:50vh;
    transform: translate(-50%,-50%);
    width: 100vw;
    height:100vh;
    background-image: var(--CoverGradient);
    animation: 0.5s ease-in-out 0.2s forwards fadein;
}
img.StoryCover {
    max-block-size: 400px;
    block-size: min(100vw,90vh);
    /*width: min(400px,80vw);/**/
    position:absolute;
    left:50%;
    top:calc(25dvh + 10px);/*calc(33dvh + 50px);/**/
    transform:translate(-50%,-50%);
    box-shadow: 0px 0px 15px 5px rgba(0,0,0,0.6);
    border: 2px solid black;
    max-height: calc(50dvh - 20px);
}
div.Announcements {
    color: black;
    font-family: var(--ActiveSub);
    font-weight: 500;
    position: absolute;
    bottom: calc(40dvh - 10px);
    height: calc(40dvh - 60px);/*calc(100dvh - min(800px,60dvh) - 60px - 20px - 90px);/**/
    left: 50%;
    transform: translate(-50%,100%);
    width: min(400px,80vw);
    border: 2px solid black;
    border-radius:3px;
    background-color: rgba(232, 223, 166, 0.75);
    padding-left:10px;
    padding-right:10px;
    overflow-y: scroll;
    box-shadow: 0px 0px 10px 0px inset;
}
div.SocialsBar {
    position:absolute;
    bottom: calc(40dvh + 25px);
    left:50vw;
    transform: translate(-50%,50%);
    width: min(300px,80vw);
    height:40px;
    padding-left:10px;
    padding-right:10px;
    display: inline-flex;
    align-items:center;
    justify-content:space-between;

}
div.SocialsBar > div {
    flex: 1;
    margin:3px;
    width: 40px;
    max-width:60px;
    height: 40px;
    border-radius: 10px;
    border: 3px solid white;    
    align-items:center;
    justify-content:middle;
    text-align:center;
}
div.SocialsBar > div:hover {
    filter:invert(0.1);
}
img.SocialIcon {
    max-width:35px;
    max-height:35px;
    position:relative;
    top:50%;
    transform:translateY(-50%);
}
div.CoverAnnounce::after {
    content:"Click anywhere to dismiss.";
    position:absolute;
    bottom:15px;
    left:50vw;
    width:100%;
    text-align: center;
    transform:translateX(-50%);
    font-size: 1.2rem;
    font-weight: 600;
    color: white;
    font-family: var(--CodyText);
    text-shadow: 0px 0px 8px black;
    
}
div.Announcements > div {
    /*padding-top:10px;/**/
    /*padding-bottom:10px;/**/
    border-top: 1px dashed black;
}
h3.Announcements {
    font-family: var(--ActiveTitle);
    font-weight: 500;
    font-size: 2rem;
    line-height:0;
    margin:0;
    margin-top:1em;
    margin-bottom:0.5em;
}
p.Announcements {
    font-family: var(--ActiveSub);
    font-weight: 500;
    padding-left:10px;
}

</style>


<body>
    <div class="imgbg codybg"></div>
    <div class="imgbg katbg"></div>
    <div class="imgbg tiebg"></div>
    <div class="TOCmain" id="TOC">     
        
    </div>
    <div class="FullContainer" id="FULL">
        <div class="ContainerLeft Gutter"></div>
        <div class="ContainerHead">
            <div class="Icon" id="ICON-LINEDN" onclick="SetPreferences('LineHeight',1)"><img class="Icon" title="Increase Line Spacing" src="https://autononymous.io/wp-content/uploads/2025/05/fbicon-LineDn.png" alt="&#8853;" ></div>
            <div class="Icon" id="ICON-LINEUP" onclick="SetPreferences('LineHeight',-1)"><img class="Icon" title="Decrease Line Spacing" src="https://autononymous.io/wp-content/uploads/2025/05/fbicon-LineUp.png" alt="&#8854;" ></div>
            <div class="Icon" id="ICON-FONTUP" onclick="SetPreferences('FontSize',1)"><img class="Icon" title="Increase Font Size"" src="https://autononymous.io/wp-content/uploads/2025/05/fbicon-Larger.png" alt="&#8853;" ></div>
            <div class="Icon" id="ICON-FONTDN" onclick="SetPreferences('FontSize',-1)"><img class="Icon" title="Decrease Font Size" src="https://autononymous.io/wp-content/uploads/2025/05/fbicon-Smaller.png" alt="&#8854;" ></div>
            <div class="Icon" id="ICON-THEME" onclick="Preferences.DisplayMode=(Preferences.DisplayMode=='Light')?'Dark':'Light';console.log('Changed color to '+Preferences.DisplayMode+'.');InvertIcons();SetScrollerEvents();runScrollEvents();SaveState();">
                <span style="color: var(--TextColor);font-size: 40px;cursor:pointer;">&#9680;</span></div>
            </div> 
        <!--  ></div> -->
        <div class="ContainerRight Gutter"></div>
        <div class="ContainerBody" id="BODY">
            <div class="Page" id="PAGE">
            </div>
            <div class="Cover" id="COVER">
            </div>
        </div>
        <div class="ContainerFooter">
            <div class="FooterProgress">
                <div class="ProgressBar" id="PROGRESS"></div>
            </div>
            <div class="FooterInfo">
                <div onclick="CurrentChapter=CurrentChapter.Previous;PlaceChapter(CurrentChapter);SaveState();" class="Footer-Left"><div class="Centered">&laquo;</div></div>
                <div class="Footer-Center">
                    <!-- moved
                    <div class="FooterContent" id="DATA" title="View Table Of Contents" onclick="ToggleTOC(true)">
                    </div>
                    -->
                </div>
                <div onclick="if((CurrentChapter.ChapterNumber < MaximumChapter)||(AuthorMode)){CurrentChapter=CurrentChapter.Next;PlaceChapter(CurrentChapter);SaveState();}else{console.warn('Outside range.')}" class="Footer-Right"><div class="Centered">&raquo;</div></div>
            </div>
        </div>
    </div>
    <div class="FloatName">
        <div class="FooterContent" id="DATA" title="View Table Of Contents" onclick="ToggleTOC()">
        </div>
    </div>
    <div class="AuthorTitle" onclick="window.open('https://autononymous.io/authors-and-stories/savantguarde/')">
        <img class="AuthorTitle" src="https://autononymous.io/wp-content/uploads/2025/06/logo-sg.png"/>
    </div>

    <div class="CoverAnnounce" style="opacity:0;" onclick="DismissAnnouncements();/*clearInterval(parsecovers)*/" id="ANNOUNCEBOX">
        <img src="PGISO2.png" class="StoryCover" id="BOOKCOV"/>
        <div class="Announcements" id="ANNOUNCE">
            Lorem Ipsum Dolor Sit Amet
        </div>
        <div class="SocialsBar">
            <div onclick="window.open('https://archiveofourown.org/users/SavantGuarde')" style="cursor: pointer;"><img src="icons/logo-ao3.png" class="SocialIcon"/></div>
            <div onclick="window.open('https://bsky.app/profile/savant-guarde.bsky.social')" target="_blank" style="cursor: pointer;"><img src="icons/logo-bs.png" class="SocialIcon"/></div>
            <div onclick="window.open('https://www.instagram.com/savant.guarde/')" style="cursor: pointer;"><img src="icons/logo-ig.png" class="SocialIcon"/></div>
            <div onclick="window.open('https://www.tumblr.com/blog/savant-guarde')" style="cursor: pointer;"><img src="icons/logo-t2.png" class="SocialIcon"/></div>
        </div>
    </div>

<script>

// ==========================<{Defining Elements}>============================ //

    const eBOOKCOVER = document.getElementById('BOOKCOV');
    const eSTARTBOX = document.getElementById('ANNOUNCEBOX');
    const eANNOUNCE = document.getElementById('ANNOUNCE');
    const eTOC = document.getElementById('TOC');
    const eFULL = document.getElementById('FULL');
    const eBODY = document.getElementsByTagName('body')[0];
    const ePAGE = document.getElementById('PAGE');
    const eWINDOW = document.getElementById('BODY');
    const ePROGRESS = document.getElementById('PROGRESS');
    const ROOT = document.querySelector(':root');
    const eDATA = document.getElementById('DATA');

    const MODES = ["Background","Text","ProgressBar"];

    const jSTYLES = ` 
    {
        "Titus":
        {
            "Light":
            {
                "Background":[240,240,240,1,1],
                "Text": [100, 24, 18 ,1],
                "ProgressBar": [100, 24, 18 ,1]
            },
            "Dark":
            {
                "Background":[20 ,18 ,18 ,1],
                "Text": [255,240,240,1],
                "ProgressBar":[255,240,240,1]
            },
            "Prefix":" = ",
            "Suffix":" = ",
            "CoverImage":"https://autononymous.io/wp-content/uploads/2025/04/firebrand__the_frostburn_chronicles_by_savant_guarde_djk23bf-414w-2x.png",
            "WallImage":""
        },
        "Katiya":
        {
            "Light":
            {
                "Background":[240,240,240,1],
                "Text": [36 ,18 ,18 ,1],
                "ProgressBar": [36 ,18 ,18 ,1]
            },
            "Dark":
            {
                "Background":[36 ,18 ,18 ,1],
                "Text": [255,200,200,1],
                "ProgressBar":[255,200,200,1]
            },
            "Prefix":" &#10048; ",
            "Suffix":" &#10048; ",
            "CoverImage":"https://autononymous.io/wp-content/uploads/2025/03/Untitled-185.png",
            "WallImage":""
        },
        "Cody":
        {
            "Light":
            {
                "Background":[240,240,240,1],
                "Text": [18 ,18 ,36 ,1],
                "ProgressBar": [18 ,18 ,36 ,1]
            },
            "Dark":
            {
                "Background":[18 ,18 ,36 ,1],
                "Text": [200,200,255,1],
                "ProgressBar":[200,200,255,1]
            },
            "Prefix":" /* ",
            "Suffix":" */ ",
            "CoverImage":"https://autononymous.io/wp-content/uploads/2025/03/Untitled-185.png",
            "WallImage":""
        },
        "Default":
        {
            "Light":
            {
                "Background":[240,240,240,1],
                "Text": [18 ,18 ,18 ,1],
                "ProgressBar": [18 ,18 ,18 ,1]
            },
            "Dark":
            {
                "Background":[18 ,18 ,18 ,1],
                "Text": [240,240,240,1],
                "ProgressBar":[240,240,240,1]
            },
            "Prefix":" ~ ",
            "Suffix":" ~ ",
            "CoverImage":"",
            "WallImage":""
        }
    }`
    const STYLES = JSON.parse(jSTYLES.replaceAll(/(\r\n|\n|\r)/gm, ''));

    // User preference settings.

    const PreferencesDefault = {
        "StartChapter":1,
        "DisplayMode":"Light",
        "FontSize":"1.5em",
        "LineHeight":"1.5em",
        "Margins": "5vw"
    }
    var Preferences = PreferencesDefault;
    const SettingsDefault = {
        "FontSize":{
            "Setting":3,
            "Options":["0.9em","1.1em","1.3em","1.5em","1.7em","1.9em","2.1em"],
            "CSSname":"--TextSize"
        },
        "LineHeight":{
            "Setting":3,
            "Options":["0.9em","1.1em","1.3em","1.5em","1.7em","1.9em","2.1em"],
            "CSSname":"--TextLineHeight"
        },
        "Margins":{
            "Setting":1,
            "Options":["5vw","10vw","15vw"],
            "CSSname":"--TextMargin"
        }
    }
    var Settings = SettingsDefault;

    ROOT.style.setProperty("--TextSize",Preferences.FontSize);
    ROOT.style.setProperty("--TextLineHeight",Preferences.LineHeight);
    ROOT.style.setProperty("--TextMargin",Preferences.Margins);
    
    var CHSET = {
        "Text":[],
        "Background":[],
        "ProgressBar":[]
    };   

    var Keyframes = {
        "Text":[],
        "Background":[],
        "ProgressBar":[]
    };

    const NewAnnouncements = {
        "06/24/25":"Test Announcement, Please Ignore",       
        "06/26/25":`&emsp;If you're reading this right now, it's for only one of two reasons: either you're one of my trusted friends or family that I've decided to share this with, or you've randomly discovered this and you're early to the show. But either way, I want to thank you for being here and supporting my work. <br><br>&emsp;PARAGATE is the second novel I've written; one that is far more personal to me. The two main characters are manifestations of anxiety and major depression that closely resemble my own struggles with these battles, and I look forward to telling you a story about what I've learned in &quot;fighting the good fight&quot; against both of them.<br><br>&emsp;This is an early release of the story, so not everything is entirely nailed down yet &mdash; but it's certainly <em>planned</em>. That being said, if it's posted here, it's in polished enough of a form that I'm confident to post it.<br><br>&emsp;If you enjoy this work, please let me know on social media, and feel free to share it with others. I'm still figuring out this self-publishing thing (and trying to spend more of my time writing than improving this Javascript applet).<br><br>Thanks again for your support.<br><br>With love,<br>&emsp;<span style="font-family:'Brush Script MT', cursive;font-size:1.5em;">Savant-Guarde :)</span>`
        }

    
    // Get parameters from search

    getParameters = () => {

        // Address of the current window
        address = window.location.search

        // Returns a URLSearchParams object instance
        parameterList = new URLSearchParams(address)

        // Created a map which holds key value pairs
        let map = new Map()

        // Storing every key value pair in the map
        parameterList.forEach((value, key) => {
            map.set(key, value)
        })

        // Returning the map of GET parameters
        return map
    }
        
    // Gets all the getParameters
    const SrcParams = getParameters();

    var AuthorMode = SrcParams.get('mode')=="author"?true:false;
    var StoryMode = SrcParams.get('story');
    console.info(StoryMode)

// ==========================<{Constant Variables}>============================ //
    // Root directory location for files
    SourceROOT  = "https://raw.githubusercontent.com/autononymous/autononymous.github.io/master/WebnovelReader/"
    //SourceTOC   = SourceROOT + "/docs/PG00TOC.json";

    var StoryName = "";
    var isTOCshown = false;
    let FILEname = "";

    switch (StoryMode) {
    case "1"||"Firebrand":
        FILEname = "/docs/FB05.json";
        StoryName = "Firebrand";
        eBOOKCOVER.src = STYLES.Titus.CoverImage;
        ROOT.style.setProperty('--CoverGradient','var(--CoverFirebrand)')
        break;   
    case "2"||"Paragate": 
    default:
        FILEname = "/docs/PG05.json";
        StoryName = "Paragate";
        eBOOKCOVER.src = STYLES.Cody.CoverImage;
        ROOT.style.setProperty('--CoverGradient','var(--CoverParagate)')
        break;
    }

    SourceFILE  = SourceROOT + FILEname;

    // ************** DEBUG local pull option ************
    //SourceFILE  = `C:/Users/rkiss/OneDrive/Documents/GitHub/autononymous.github.io/WebnovelReader/docs/PG04.json`;
  
    

    console.log(SrcParams)

    //var parsecovers = setInterval(ChangeCover,10000);

    if(AuthorMode) {
        console.info("> Running in Author Mode: or Cheater Mode for very perceptive code monkeys that want to preview unfinished releases before they are available.")
    } else {
        console.info("> No parameters present.")
    }

    // Date Key for determining the most recent file (****UPDATE!****)
    DATEKEY = "Tuesday, May 13, 2025";

    // Miscellaneous variables
    DebugLog = "";
    function debugLog(text,mode) {
        DebugLog += text;
        if (mode) {
            console.debug(DebugLog);
            DebugLog = "";
        }
    }
    // Start date from Autononymous release day on March 14, 2025.
    const tSTART = new Date("2025-03-14T00:00:00Z"); 
    //var RelDate = new Date(Date.parse(StartDate) - (86400000*7));
    const dBEGIN = 56; //************Story release relative date
    const dSTART = yeardate(tSTART);

    // Current date.
    const tNOW = new Date();
    const dNOW = yeardate(tNOW);

    console.debug(`Start date is ${dSTART}.\nToday is ${dNOW}, ${dNOW-dSTART} days later.`)

    const sTrans2       = 5; //--------------------------------------------------------------

    const sTransition   = .5; //percent
    const sHold         = .5; //percent
    const sOffset       = 0; //percent

// ==========================<{Changing Variables}>============================ //
    var STORY = [];
    var INFO;
    var CurrentChapter;
    var MaximumChapter = 0;
    var ScrollProgress = 0;
    var PageElementList = [];
    var Position = 0;

    var ShownCover = 1;

    ThisStoryTheme = "Default"
    LastStoryTheme = "Default"

    var CODY_Opacity    = 0.00;
    var KAT_Opacity     = 0.00;
    var TIE_Opacity     = 0.00;

    

// ==============================<{Functions}>======================== //

function LoadAnnouncements() {
    eSTARTBOX.style.opacity="1";
    eANNOUNCE.innerHTML = `<div><h3 class="Announcements"> Announcements </h3></div>`;
    Object.entries(NewAnnouncements).reverse().forEach( ([timestamp,content]) => {
        eANNOUNCE.innerHTML += `<div> <p><strong><u>${timestamp}: </u></strong></p><p class="Announcements"> ${content}</p></div>`;
    })
}
function DismissAnnouncements() {
    //this.outerHTML = "";
    eSTARTBOX.style.animation = '1.0s ease-in-out 0.5s forwards fadeout';
    eSTARTBOX.style.pointerEvents = "none";
}
/*
function ChangeCover() {
    ShownCover = ShownCover==4?1:ShownCover+1;
    switch (ShownCover) {
        case 1:
            eBOOKCOVER.src = "https://autononymous.io/wp-content/uploads/2025/06/cover03.png"
            break;
        case 2:
            eBOOKCOVER.src = "https://autononymous.io/wp-content/uploads/2025/03/Untitled-185.png"
            break;
        case 3:
            eBOOKCOVER.src = "https://autononymous.io/wp-content/uploads/2025/06/cover02a-scaled.png"
            break;
        default:
            eBOOKCOVER.src = "PGISO2.png"
            break;
    }
}
*/
//__________________________________________________________________
//     NAME: | > yeardate
// CATEGORY: | > Time
//  PURPOSE: | > Get relative date.
//       IN: | > Standard formatted date.
//   MODIFY: | > None.
//      OUT: | > Integer relative date.
//
function yeardate(date) {
    const month = date.getMonth();
    var result = date.getDate();
    for (let i = 0 ; i < month ; i++) {
        result += new Date(date.getFullYear(),i+1,0).getDate();
    }
    result += (date.getFullYear()-2025)*365;
    return result;
}




//__________________________________________________________________
//     NAME: | > clearLocalStorage
// CATEGORY: | > Initializing
//  PURPOSE: | > Function to run in console to test loading files.
//       IN: | > 
//   MODIFY: | > 
//      OUT: | > 
//
function clearLocalStorage() {
    localStorage.removeItem('AC_SAVE');
    localStorage.removeItem('AC_SETTINGS');
    localStorage.removeItem('AC_PREFS');
}

function SaveState() {    
    localStorage.setItem('AC_SETTINGS',JSON.stringify(Settings))
    localStorage.setItem('AC_PREFS',JSON.stringify(Preferences));
    console.debug(' > User preferences saved to internal storage.')
}
function LoadPreferences() {
    let saveprefs = localStorage.getItem('AC_PREFS');
    let savesettings = localStorage.getItem('AC_SETTINGS');
    if (saveprefs && savesettings) {
        try {
            Preferences = JSON.parse(saveprefs);
            Settings = JSON.parse(savesettings);

            Object.values(Settings).forEach( setting  => {                
                ROOT.style.setProperty(setting.CSSname,setting.Options[setting.Setting]);
            });      

            CurrentChapter = STORY[Preferences.StartChapter];

            let newstate = (Preferences.DisplayMode=="Dark")?0:1;
            ROOT.style.setProperty("--IconState",`invert(${newstate})`)
   
            console.debug(" > User preferences successfully loaded from Local Storage.")
        } catch (error) {
            console.debug(" > Unable to load user preferences from saved. \n << ERRORTEXT: " + error + " >>")
            // Reset to default.
            Preferences = PreferencesDefault;
            Settings = SettingsDefault;


        }
    } else {
        console.debug(" > Preferences have not been set yet.")
    }
}


function InvertIcons() {
    let newstate = (Preferences.DisplayMode=="Dark")?0:1;
    ROOT.style.setProperty("--IconState",`invert(${newstate})`)
    SetMessageState();
}
function SetMessageState() {
    let newstate = (Preferences.DisplayMode=="Dark")?0:1;
    ROOT.style.setProperty("--MsgColorTo",(newstate==0?"rgba(33, 138, 255, 0.8)":"rgba(33, 138, 255, 0.8)"));
    ROOT.style.setProperty("--MsgFontColorTo",(newstate==0?"white":"white"));
    ROOT.style.setProperty("--MsgColorFrom",(newstate==0?"rgba(129, 129, 129, 0.8)":"rgba(235, 235, 235, 0.8)"));//"rgba(216, 216, 216, 0.8)"));
    ROOT.style.setProperty("--MsgFontColorFrom",(newstate==0?"white":"black"));
}

function SetPreferences(property,increment) {
    let Params = Settings[property];
    let range = [ 0 , Params.Options.length ];
    let current = Params.Setting;
    let queried = current + increment;

    if (queried >= range[0] && queried < range[1]) {
        Params.Setting = queried;
        Preferences[property] = Params.Options[queried];
        ROOT.style.setProperty(Params.CSSname,Preferences[property])
        console.info(` > Parameter '${property}' is now set to ${Preferences[property]}.`)

        SaveState();

        SetScrollerEvents();
        runScrollEvents();

    } else {
        console.warn(` > Parameter setting for '${property}' is out of bounds [${range[0]},${range[1]}].`)
    }

}

//__________________________________________________________________
//     NAME: | > fetchJSON
// CATEGORY: | > Initializing
//  PURPOSE: | > Either load local save if it exists (to reduce server load),
//           |   or pull data from server.  Formats data through ParseStory().
//       IN: | > 
//   MODIFY: | > 
//      OUT: | > 
//
async function fetchJSON() {
    // Check if we already have this saved locally first.
    let SavedContent = localStorage.getItem('AC_SAVE');
    if(SavedContent) {
        try {
            let jSavedContent = JSON.parse(SavedContent.replaceAll(/(\r\n|\n|\r)/gm, ''));
            if (jSavedContent.Created == DATEKEY) {
                let result = ParseStory(jSavedContent);
                debugLog("> Loaded existing text in local storage.\n",true);
                return result;
            }
        } catch (error) {
            debugLog("> Error loading existing text in local storage.\n"+error+"\n",false);
        }
    }
    // If not, proceed to load.
    try {
        const response = await fetch(SourceFILE);
        if (!response.ok) {
            debugLog("> ERROR: Network response failure for story JSON.\n",false);
        }
        const data = await response.text();
        let jDATA = JSON.parse(data.replaceAll(/(\r\n|\n|\r)/gm, ''));
        //console.log(jDATA);
        let result = ParseStory(jDATA);
        localStorage.setItem('AC_SAVE',JSON.stringify(jDATA))
        debugLog("> Story successfully loaded.\n",true);
        return result;
    } catch (error) {
        debugLog("> Error in fetch process.\n> "+error,false);
    }
    debugLog("",true);
}

//__________________________________________________________________
//     NAME: | > ParseStory
// CATEGORY: | > Initializing
//  PURPOSE: | > Format the exported JSON file into something more readable.
//       IN: | > 
//   MODIFY: | > 
//      OUT: | > 
//
function ParseStory(data) {

    // Chapters need to be counted.
    let c = 0;

    // Release dates need to be calculated.
    let ThisDate = dSTART + 0;

    // Pull non-Manuscript data first.
    INFO = {
        "Author": data.Author,
        "Created":data.Created,
        "ShortName":data.Nickname,
        "FullName":data.Project,
        "TotalWords":data.WordCount
    };

    // Iteratively load the JSON export file into something more accessible.
    
    // Variables for last and next chapter data:
    //console.debug(data)

    let Story = Object.values(data.Manuscript);
    let eRelease = dSTART;
    //console.log(Story)
    for (let i=0; i<Story.length; i++) {
        // Save story array to 'entry' for easier sightreading.
        let entry = Story[i];
        let ePerspective="";       

        // Iterate for each entry of the singular JSON file.
        switch(entry.DocType) {
        case "Chapter":            
            let eTitle = (entry.ChapterOverride==""||entry.ChapterOverride==undefined)?entry.AutoNameFull:entry.ChapterOverride;
            let eSubtitle = (entry.GivenName=="")?"":entry.GivenName;
            let eActNumber = entry.ActNum;
            let eChapterNumber = entry.ChapterFull;
            let eNextPub = parseFloat(entry.NextPublish);
            let eSynopsis = entry.Synopsis;
            let eID = (entry.VerboseOverride==undefined)?(entry.ActNum-1+"."+entry.ChapterFull):entry.VerboseOverride;
            let ePublishOn = entry.PublishOn;

            //console.warn(entry.PublishOn=="")

            ePerspective = ((entry.Perspective=="Mixed")||(entry.Perspective==""))?"Default":entry.Perspective;
            //console.error(entry.VerboseOverride)
            let prefix = STYLES[ePerspective].Prefix;
            let suffix = STYLES[ePerspective].Suffix;
            
            if (ePublishOn=="") {
                eRelease += eNextPub;
            } else {
                eRelease = parseFloat(ePublishOn);
            }
            
            if (eRelease <= dNOW || AuthorMode) {
                MaximumChapter++;
            }

            STORY.push(
            {
                "Title":eTitle,
                "Subtitle":eSubtitle,
                "Act":eActNumber,
                "ChapterNumber": eChapterNumber,
                "Synopsis":eSynopsis,
                "ID":eID,
                "Body":[],
                "BodyFormatted":[],
                "Release":eRelease,
                "Active":eRelease<=dNOW,
                "Perspective":ePerspective,
                "Previous":"",
                "Next":""
            });
            STORY[STORY.length-1].BodyFormatted.push(`<h3 id="title_${entry.ChapterFull}" class="${ePerspective} Title">${eTitle}</h3>`);
            STORY[STORY.length-1].BodyFormatted.push(`<h3 id="sub_${entry.ChapterFull}" class="${ePerspective} Subtitle">${prefix + eSubtitle + suffix}</h3>`);
    
            // Set 'next' and 'previous' chapters as circular objexts
            if (c==0) {
                STORY[STORY.length-1].Previous = STORY[STORY.length-1];
            } else if (c==STORY.length-1) {
                STORY[STORY.length-1].Previous = STORY[STORY.length-2];
                STORY[STORY.length-2].Next = STORY[STORY.length-1];
                STORY[STORY.length-1].Next = STORY[0];
            } else {
                STORY[STORY.length-1].Previous = STORY[STORY.length-2];
                STORY[STORY.length-2].Next = STORY[STORY.length-1];
            }

            c++;
            break;
        case "Scene":
            let eBody = entry.Body.replaceAll('<p>','\n').replaceAll('</p>','').split('\n');         
            ePerspective = ((entry.Perspective=="Mixed")||(entry.Perspective==""))?"Default":entry.Perspective;

            let LineIndex = 1;
            let WritingMessage = false; // Generating message div.
            STORY[STORY.length-1].BodyFormatted.push(`<h3 id="${entry.ChapterFull}.${entry.SceneFull}" class="${ePerspective} Section">${entry.ScenePart}</h3>`);
            eBody.forEach(passage => {
                if (passage != "") {
                    STORY[STORY.length-1].Body.push(passage);
                    if (passage.search("msg") != -1) {
                        let msgtype = 
                            (passage.search("CodyHand") != -1) ? "CodyHand" :
                            (passage.search("KatiyaHand") != -1) ? "KatiyaHand" :
                            (passage.search("TitusHand") != -1) ? "TitusHand" :
                            (passage.search("msgfromdate") != -1) ? "msgfrom" :
                            (passage.search("msgfrom") != -1) ? "msgfrom" :
                            (passage.search("msgtodate") != -1) ? "msgto" :
                            (passage.search("msgto") != -1) ? "msgto" : "";

                        let writershand = "";
                        if (msgtype == "msgnote") {
                            writershand = `${ePerspective}Hand`;
                            passage = passage.replaceAll("msgnote",`${writershand} msgnote`)
                        }
                        
                        if ((WritingMessage == false) || (WritingMessage == true && (passage.search("msgfromdate") != -1 || passage.search("msgtodate") != -1))) {
                            STORY[STORY.length-1].BodyFormatted.push(
                                `<p id="${entry.ChapterFull}.${entry.SceneFull}.${LineIndex++}" class="${ePerspective} ${msgtype} ${writershand}">`
                                + passage
                            );                   
                            WritingMessage = true;
                        } else {
                            //console.log(passage)
                            STORY[STORY.length-1].BodyFormatted[STORY[STORY.length-1].BodyFormatted.length-1] += '<br>' + (passage);
                        }
                        //console.warn(passage)
                    } else {
                        if(WritingMessage == true) {
                            WritingMessage = false;
                            STORY[STORY.length-1].BodyFormatted[STORY[STORY.length-1].BodyFormatted.length-1] += (`</p>`);
                        }
                        
                        STORY[STORY.length-1].BodyFormatted.push(
                            `<p id="${entry.ChapterFull}.${entry.SceneFull}.${LineIndex++}" class="${ePerspective}">`
                            + passage
                            + `</p>`
                    )   ;
                    }
                    
                }              
            });
            break;
        default:
            break;
        }
    }
    return data;
}

function Event_Pulse( keyframe, progress, previous, next, transition, hold , offset , wasTheme, isTheme) {
    let pStart  = progress - (transition/2) - (hold/2) + offset;
    let pEnd    = progress + (transition/2) + (hold/2) + offset;

    // Initial node.
    keyframe.push([progress,previous[0],previous[1],previous[2],previous[3], wasTheme, isTheme]);
}
function Event_Switch( keyframe, progress, previous, next, transition, hold , offset , wasTheme, isTheme ) {
    // NOTE: 'hold' has no effect.
    let pStart  = progress - (transition/2) + offset;
    let pEnd    = progress + (transition/2) + offset;

    keyframe.push([pStart,previous[0],previous[1],previous[2],previous[3], wasTheme, isTheme]);
    keyframe.push([pEnd,next[0],next[1],next[2],next[3], wasTheme, isTheme]);


}


function SetScrollerEvents() {
    let PageElements = ePAGE.childNodes;
    let LastStyle = "Default";//PageElements[0].className.split(" ")[0];
    let ThisStyle = PageElements[0].className.split(" ")[0];

    Keyframes = {
        "Text":[],
        "Background":[],
        "ProgressBar":[]
    };

    // Start on neutral theme.
    let Progress = 0;
    let Style = STYLES["Default"][Preferences.DisplayMode]
    MODES.forEach( mode  => {
        Keyframes[mode].push([Progress,Style[mode][0],Style[mode][1],Style[mode][2],Style[mode][3], LastStyle+"", ThisStyle+""]);
        let last = STYLES[LastStyle][Preferences.DisplayMode][mode]
        let next = STYLES[ThisStyle][Preferences.DisplayMode][mode]
        Previous = [last[0],last[1],last[2],last[3]];
        Next = [next[0],next[1],next[2],next[3]];
        Event_Switch(Keyframes[mode],Progress,Previous,Next,4.00,0.00,2.00, LastStyle+"", ThisStyle+"");
    });

    let IsFirstElement = true;

    for (let i=0; i<PageElements.length; i++) {
        element = PageElements[i];
        // Get previous style and current style.
        LastStyle = ThisStyle + "";
        ThisStyle = element.className.split(" ")[0];

        if ( (ThisStyle != LastStyle) ) { //|| (IsFirstElement && (element.tagName == "P")) || (i == PageElements.length-5) ) {
            //console.log("Style change.",LastStyle,ThisStyle)
            IsFirstElement = false;
            let Progress = ScrollPosition(element);
            let Style = STYLES[ThisStyle][Preferences.DisplayMode];
            MODES.forEach( mode  => {
                let last = STYLES[LastStyle][Preferences.DisplayMode][mode]
                let next = STYLES[ThisStyle][Preferences.DisplayMode][mode]
                Previous = [last[0],last[1],last[2],last[3]];
                Next = [next[0],next[1],next[2],next[3]];
                Event_Switch(Keyframes[mode],Progress,Previous,Next,sTrans2,sHold,-0.5, LastStyle+"", ThisStyle+"");
            });
        }
    }



    // End on neutral theme.
    Progress = 100;
    Style = STYLES["Default"][Preferences.DisplayMode]
    ThisStyle = "Default";
    MODES.forEach( mode  => {
        let last = STYLES[LastStyle][Preferences.DisplayMode][mode]
        let next = STYLES[ThisStyle][Preferences.DisplayMode][mode]
        Previous = [last[0],last[1],last[2],last[3]];
        Next = [next[0],next[1],next[2],next[3]];
        Event_Switch(Keyframes[mode],Progress,Previous,Next,2.00,0.00,-2.00, LastStyle+"", ThisStyle+"");
        Keyframes[mode].push([Progress,Style[mode][0],Style[mode][1],Style[mode][2],Style[mode][3], LastStyle+"", ThisStyle+""]);
    });

   
    //--console.log(PageElementList);
    //--console.log(LastStyle)
    //--console.debug(Keyframes)
}


function ChannelSet(CHANNEL) {
    LastElement = CHANNEL[0];
    NextElement = CHANNEL[1];
    for (let i=0; i<CHANNEL.length-1; i++) {
        if (CHANNEL[i][0] < Position) {
            LastElement = Object.assign({}, CHANNEL[i]);
            NextElement = Object.assign({}, CHANNEL[i+1]);
        }
    }      
    let Progress = (NextElement[0]-Position)/(NextElement[0]-LastElement[0])
    
    /*
    console.debug(`
    Last Element: ${LastElement[0]},${LastElement[1]},${LastElement[2]},${LastElement[3]}\n
    Next Element: ${NextElement[0]},${NextElement[1]},${NextElement[2]},${NextElement[3]}\n
    Position: ${Position}\n
    Progress: ${Progress}
    `);
    */

    //console.log(LastElement,NextElement)

    /*
    console.info(`
    LAST:\t${LastElement[5]}\t${LastElement[6]}\n
    NEXT:\t${NextElement[5]}\t${NextElement[6]}\n
    ${Progress}
    `)
    */

    let RED = (LastElement[1]*Progress)+(NextElement[1]*(1-Progress));
    let GRN = (LastElement[2]*Progress)+(NextElement[2]*(1-Progress));
    let BLU = (LastElement[3]*Progress)+(NextElement[3]*(1-Progress));      
    let ALP = ((NextElement[5]=="Cody")*Progress)+((LastElement[6]=="Cody")*(1-Progress));    
        
    let FadeThresh = 0.93
    let StartEndPerc = Math.abs(Position-50)*2;
    let StartEndOff = StartEndPerc-(100*FadeThresh)
    let StartEndMul = StartEndOff<0 ? 1 : 1-(StartEndOff/(100-(100*FadeThresh)))

    //console.log(StartEndMul)

    //CODY_Opacity = ALP * StartEndMul;
    //KAT_Opacity = (1-ALP) * StartEndMul;

    let State1 = `${LastElement[5]}${LastElement[6]}`;
    let State2 = `${NextElement[5]}${NextElement[6]}`;

    CODY_Opacity = ((NextElement[5]=="Cody") * Progress)  + ((LastElement[6]=="Cody") * (1-Progress));
    KAT_Opacity = ((NextElement[5]=="Katiya") * Progress) + ((LastElement[6]=="Katiya") * (1-Progress));
    TIE_Opacity = ((NextElement[5]=="Titus") * Progress)  + ((LastElement[6]=="Titus") * (1-Progress));

    /*
    if( ((LastElement[6]=="Default") && (NextElement[6]=="Default")) || ((LastElement[5]=="Default") && (NextElement[5]=="Default"))) {
        CODY_Opacity = KAT_Opacity = 0;
    }
    */

    let IsStartOf = false;

    if((NextElement[5]=="Cody")&&(LastElement[6]=="Cody")) {
        ThisStoryTheme = "Cody";
    } else if ((NextElement[5]=="Katiya")&&(LastElement[6]=="Katiya")) {
        ThisStoryTheme = "Katiya";
    } else if ((NextElement[5]=="Titus")&&(LastElement[6]=="Titus")) {
        ThisStoryTheme = "Titus";
    } else {
        ThisStoryTheme = "Default";
    }
    
    if ((LastElement[6]=="Default")&&(NextElement[6]=="Default")) {
        ThisStoryTheme = LastElement[5];
        IsStartOf = true;
    } else if ((LastElement[5]=="Default")&&(NextElement[5]=="Default")) {
        ThisStoryTheme = NextElement[6];
        IsStartOf = true;
    }

    //console.log(ThisStoryTheme)

    if((ThisStoryTheme != LastStoryTheme) || IsStartOf) {

        if(ThisStoryTheme == "Cody") {
            ROOT.style.setProperty("--ActiveTitle","var(--CodyTitle)")
            ROOT.style.setProperty("--ActiveSub"  ,"var(--CodyText )")
            ROOT.style.setProperty("--ActiveSize" ,"1.1em")
        } else if (ThisStoryTheme == "Katiya") {
            ROOT.style.setProperty("--ActiveTitle","var(--KatiyaTitle)")
            ROOT.style.setProperty("--ActiveSub"  ,"var(--KatiyaText )")
            ROOT.style.setProperty("--ActiveSize" ,"1.2em")
        } else if (ThisStoryTheme == "Titus") {
            ROOT.style.setProperty("--ActiveTitle","var(--TitusTitle)")
            ROOT.style.setProperty("--ActiveSub"  ,"var(--TitusText )")
            ROOT.style.setProperty("--ActiveSize" ,"1.2em")
        } else {

        }
    }
    
    LastStoryTheme = ThisStoryTheme + "";


    return [RED,GRN,BLU,ALP];
}

function ToggleTOC() {
    isTOCshown = !isTOCshown    
    eFULL.style.top = (isTOCshown)?  '0'  :  '-110vh'  ;
    eFULL.style.animation = ("1s ease-in-out 0.25s forwards" + ((isTOCshown)?" slide-up ":" slide-down "));
    eTOC.style.animation = ("1s ease-in-out 0.25s forwards" + ((isTOCshown)?" fadein ":" fadeout "));
    eFULL.style.opacity = (isTOCshown)?  1  :  0  ;
    eTOC.style.opacity  = (isTOCshown)?  1  :  0  ;     
    eFULL.style.pointerEvents = (isTOCshown)?"none":"all";
       
}

// Legacy TOC functions ==========================
var TOCchapterTARGET = "";
function TOChtmlACT(nAct,name) {
    let result = `
    <div id="TOC-ACT${nAct}" class="TOC Act">
        <div id="TOC-ACT${nAct}-ROW" class="TOC ActRow">          
            ${name} 
        </div>
        <div class="ChapterSet" id="TOC-ACT${nAct}-CHAPTERS">
        </div>
    </div>
    `
    TOCchapterTARGET = `TOC-ACT${nAct}-CHAPTERS`;
    return result;
}
function TOChtmlCHAPTER(nChap,name,synopsis,pubdate,nDisplayed,percent,isnew) {
    //console.info(`${nChap},${name},${synopsis},${pubdate},${nDisplayed},${percent},${isnew}`)
    ChapterIsActive = (nChap <= MaximumChapter);
    //console.info(MaximumChapter)
    let ChapterInteraction = ChapterIsActive?(`class="TOC ChapterRow activerow ${isnew?'newrow':''}"  onclick="CurrentChapter=STORY[${nChap-1}];PlaceChapter(CurrentChapter);SaveState();ToggleTOC();"`):(`class="TOC ChapterRow inactiverow ${isnew?'newrow':''}"`);

    let result = `    
        <div id="TOC-CH${nChap}" ${ChapterInteraction}> 
            <div id="TOC-CH${nChap}-DATE" class="TOC ChapterDate">${pubdate}</div>
            <div class="TOCmarker" ${ChapterIsActive?'style="background-color: rgba(var(--ColorSecondary),1"':''}></div>
            <div id="TOC-CH${nChap}-STATE" class="ChapterState" style="height:${percent}%"></div>
            <div id="TOC-CH${nChap}-NUM" class="TOC ChapterNumber"><span>${('00'+nDisplayed).slice(-2)}</span></div>
            <div id="TOC-CH${nChap}-DESC" class="TOC ChapterDescription">
                <div id="TOC-CH${nChap}-NAME" class="TOC ChapterName">${name}</div>
                <div id="TOC-CH${nChap}-SYN" class="TOC ChapterSynopsis">${synopsis}</div>
            </div>            
        </div>
    `;
    return result;
}

function pad(num, size) {
    var s = "000000000" + num;
    return s.substr(s.length-size);
}

function AdjustedIndex(index) {
    return (index < 2)?0:index-2;
}

async function BuildTOC() {
    //console.debug("Building the Table Of Contents...");
    eTOC.innerHTML = ''; //TOC clear ------------------------//    
    let RelDate = tSTART;

    let today = parseFloat(yeardate(tNOW));
    let startday = parseFloat(yeardate(tSTART));
    let releaseday = parseFloat(yeardate(tSTART));
    let lastrelease = releaseday + 0;

    //console.log(`${today}, ${startday}, ${releaseday}`)
    let ChapterMaxNumberT = 0;
      
    let ActCtr = 0;  
    jSTORY.Manuscript.forEach( parcel => {
        let pType = parcel.DocType;
        let pAct = parcel.ActNum;
        let pChapter = parcel.ChapterFull;
        let pScene = parcel.SceneFull;   
        
        let ChapterIsActive = true;

        let DatePercentage = 1;    
        
        //console.warn(`${pType},${pAct},${pChapter},${pScene}`)

        switch (pType) {
            case "Act":
                ActCtr++;
                //console.log("Act "+ActCtr)
                eTOC.innerHTML += TOChtmlACT(ActCtr,parcel.DocName);
                break;
            case "Chapter":
                //console.info(`${today} ... ${releaseday}`)
                let NextPush = parcel.NextPublish==undefined?7:parcel.NextPublish;
                if (parcel.PublishOn==""){
                    releaseday += parseFloat(NextPush);
                } else {
                    releaseday = parseFloat(parcel.PublishOn);
                    NextPush = releaseday - lastrelease;
                }

                //console.debug(NextPush)
                
                ChapterMaxNumberT++;
                RelDate = new Date(Date.parse(RelDate) + (86400000*parseFloat(NextPush)));
                let EntryDateStr = `${pad(RelDate.getMonth()+1,2)}/${pad(RelDate.getDate(),2)}`// /${RelDate.getFullYear().toString().slice(2,4)}`
                //console.warn(EntryDateStr)
                document.getElementById(TOCchapterTARGET).innerHTML += TOChtmlCHAPTER(parcel.ChapterFull,parcel.GivenName,parcel.Synopsis,EntryDateStr,AdjustedIndex(parcel.ChapterFull),DatePercentage,
                ((today >= releaseday)&&(today <= (releaseday+7) )) )
                // Calculating height of date progress bar:                  

                if (today >= releaseday) {
                    DatePercentage = 1;
                } else if (today <= startday) {
                    DatePercentage = 0;
                } else {
                    DatePercentage = (today - startday) / (releaseday - startday);
                }
                let VertBar = document.getElementById(`TOC-CH${parcel.ChapterFull}-STATE`)

                //console.log(`Release #${ChapterMaxNumberT}\n  starts ${startday},\n  now is ${today},\n  ends ${releaseday}\n  percentage ${DatePercentage}.`)
                
                VertBar.style.height = `${DatePercentage * 100}%`;
                VertBar.style.top = `
                ${((-0.5) - ((1-DatePercentage)/2))*100}%`;
                
                startday = releaseday + 0;
                lastrelease = releaseday + 0;
                break;
        }
    });
}



//__________________________________________________________________
//     NAME: | > PlaceChapter
// CATEGORY: | > Init, UI Response
//  PURPOSE: | > Set chapter text into BODY. Set up scroll events.
//       IN: | > Chapter number.
//   MODIFY: | > 
//      OUT: | > 
//
function PlaceChapter(CHAPTER) {
    StartChapter = CurrentChapter.ChapterNumber;
    // NOTE: Chapter number is (1) ahead of indexing. 
    ePAGE.innerHTML = "";
    //console.log(CHAPTER.Active)
    if( CHAPTER.Active || AuthorMode) {
        CHAPTER.BodyFormatted.forEach( Line => {
            ePAGE.innerHTML += Line;
        }) 
        //ePAGE.innerHTML += `<div class="EndSpacer"></div>`;
        eWINDOW.scrollTop = 0;
        Preferences.StartChapter = CurrentChapter.ChapterNumber-1;
        SetScrollerEvents();    
        SetInfo();        
    } else {
        ePAGE.innerHTML += "Chapter is not active yet. Check back later."
    }
}


//__________________________________________________________________
//     NAME: | > Setup
// CATEGORY: | > Initializing
//  PURPOSE: | > Initializes all data, loading story and content.
//       IN: | > 
//   MODIFY: | > 
//      OUT: | > 
//
async function setup() {    

    // Get and format the story JSON file.
    jSTORY = await fetchJSON();

    LoadPreferences();

    LoadAnnouncements();

    // Set current chapter.
    CurrentChapter = STORY[Preferences.StartChapter];
    PlaceChapter(CurrentChapter);

    //console.error(Preferences.DisplayMode)

    runScrollEvents();

    SetInfo();

    SetMessageState();

    BuildTOC();
    
}

function ScrollPosition(elem) {
    let PageRect = ePAGE.getBoundingClientRect();
    let ItemRect = elem.getBoundingClientRect();
    let BodyRect = eWINDOW.getBoundingClientRect();

    let PageHeight = PageRect.height - BodyRect.height;
    let PositionHeight = ItemRect.top - BodyRect.top;
    let ScrollPos = Math.abs(((PositionHeight/PageHeight)*100))
    ScrollPos = (ScrollPos>=100)?
                        100:
                        ((ScrollPos<=0)?
                            0:
                            ScrollPos);

    /*
    console.debug(`
    Page height is at ${PageRect.height} - ${BodyRect.height} = ${PageHeight}.
    Position height is at ${ItemRect.top} - ${BodyRect.top} = ${PositionHeight}.
    `);
    */
    return ScrollPos;
}

function ApplyColors() {

    ROOT.style.setProperty("--TextColor",`rgba(${CHSET["Text"][0]},${CHSET["Text"][1]},${CHSET["Text"][2]},${1})`);
    ROOT.style.setProperty("--BackgroundColor",`rgba(${CHSET["Background"][0]},${CHSET["Background"][1]},${CHSET["Background"][2]},${1})`);
    ROOT.style.setProperty("--BarColor",`rgba(${CHSET["ProgressBar"][0]},${CHSET["ProgressBar"][1]},${CHSET["ProgressBar"][2]},${1})`);
    ROOT.style.setProperty("--HoverColor",`rgba(${CHSET["ProgressBar"][0]},${CHSET["ProgressBar"][1]},${CHSET["ProgressBar"][2]},${0.1})`);
    ROOT.style.setProperty("--TOCbackground",`rgba(${CHSET["ProgressBar"][0]},${CHSET["ProgressBar"][1]},${CHSET["ProgressBar"][2]},${0.03})`);
    ROOT.style.setProperty("--CodyOp",CODY_Opacity); /*CHSET["Background"][3]);/**/
    ROOT.style.setProperty("--KatOp",KAT_Opacity); /*1-CHSET["Background"][3]);/**/
    ROOT.style.setProperty("--TieOp",TIE_Opacity); /*1-CHSET["Background"][3]);/**/
    //console.log(CHSET["Background"][3])
}

function SetInfo() {
    eDATA.innerHTML = 
          "<h4 class='InfoTitle'>" + StoryName + " " + CurrentChapter.ID + "</h4><p class='InfoSub'>"
        + CurrentChapter.Title + "<br>"
        + CurrentChapter.Subtitle + "</p>"
        ; 
}

function runScrollEvents() {
    Position = ScrollPosition(ePAGE);
    //console.log(ScrollProgress);
    ePROGRESS.style.width = `${Position}%`;   

    MODES.forEach( mode => {
        CHSET[mode] = ChannelSet(Keyframes[mode])
    })

    ApplyColors();
    
    //console.log(CHSET["Background"][3]) /**-*/
    
}



// ==========================<{Function Code}>============================ //

eWINDOW.addEventListener('scroll',runScrollEvents);
setup();

</script>
</body>
</html>

<!--Wastebin
  let MinChapter = 1;
    let MaxChapter = STORY.length;
    let ThisChapter = CHAPTER.ChapterNumber;

    if (ThisChapter > MaxChapter) {
        console.warn(` > Chapter ${ThisChapter} is above maximum chapter of ${MaxChapter}.`);
        return;
    } else if (ThisChapter < MinChapter) {
        console.warn(` > Chapter ${ThisChapter} is below minimum chapter of ${MinChapter}.`);
        return;
    } else {
        console.info(` > Loading Chapter ${ThisChapter}.`)
    }
    while
-->