<!DOCTYPE html>
<html>

<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Reader</title>

  <style>

:root {
  --bordercolor: transparent;
  --ctrltransp: 0.01;
}

body {
  background-color: grey;
  color:white;
}

h3.hAct {
  font-size: 4rem;
  text-align: center;
}
h3.hChap {
  font-family: 'Courier Prime', 'Courier';
  font-variant: small-caps;
  font-size: min(4rem,8vw);
  line-height: 1em;  
  margin-bottom:-0.5em;
  text-decoration: underline;
  text-align: center;
}
h3.hSub {
  font-family: 'Courier Prime', 'Courier';
  font-size: min(3rem,6vw);
  font-variant: small-caps;
  line-height: 1.0em;
  margin-bottom:-1em;
  text-align: center;
}
/*
h3.hSub:before {
  content:'"';
}
h3.hSub:after {
  content:'"';
}
  */
h3.hScn {
  font-size: min(4rem,6vw);
  margin-top:2em;
  text-align: center;
} 
h3.hScn:before {
  content:"-";
}
h3.hScn:after {
  content:"-"
}

p.Para {
  font-size: 1.5em;
}

div.options {
  border: 1px solid gray;
  position: absolute;
  top:400px;
  height:60px;
  width: 100%;
  display: inline-flex;
}

div.positioner {
/* Center contents*/
  position:absolute;
  width: min(800px,100%);
  height: 100%;
  transform: translate(-50%,0);
  top:0;
  left: 50%;
  height: 100%;
}
div.fullbody {
  border: 2px solid var(--bordercolor);
  width: 100%;
  height: 100%;
  max-width: 800px;
}
div.fullbody > div {
  border: 2px solid var(--bordercolor);
}

div.header {
  height: 500px;
  background-color: #151515;
}

div.body {
  background-color: #151515;
  text-wrap: wrap;
  height: 80%;
  overflow-y: hidden;
}
div.interface {
  z-index:1;
  position: absolute;
  top: 500px;
  left:0;
  height: 100%;
  width: 100%;
  display: inline-flex;
  /*
  background-image: linear-gradient(
      to bottom,
      #151515 10%,
      transparent 20%,
      transparent 80%,
      #151515 90%
  )
    */
}
div.control {
  border:1px solid var(--bordercolor);
  flex:1;
}
div.left {
  background-color: rgba(128, 128, 255, var(--ctrltransp));
}
div.right {
  background-color: rgba(255, 128, 128, var(--ctrltransp));
}

div.reader {
  z-index:0;
  margin-left:30px;
  margin-right: 30px;
  text-align: justify;
}
div.page {
  background-color: rgba(255,255,255,0.00);
  
}

div.tracker {
  background-color: #151515;
  height: 10vh;
  text-align: center;
}
div.bonus {
  background-color: #151515;
  height: 30vh;
}
div.titleimage {
  background-image: url('https://autononymous.io/wp-content/uploads/2024/11/IMG_0373.png');
  background-position: center;
  background-size: cover;
  position:relative;
  width: 80%;
  height:200px;
  top:30px;
  margin:auto;
  box-shadow: 0px 0px 20px 20px #151515 inset
}


div.ctrl {
  flex:4;
}
div.ctrl-fontup {
  text-align: center;
  font-size: 2em;
  margin: auto;
  flex: 1;
  background-color: rgba(128, 255, 128, 0.1);
}
div.ctrl-fontdn {
  text-align: center;
  font-size: 2em;
  margin: auto;
  flex: 1;
  background-color: rgba(255, 128, 128, 0.1);
}
  </style>

  
</head>
<body>
  <div class="positioner">
    <div class="fullbody">
    <div class="header">
      <div class="titleimage">   
      </div>
      <div class="options">
        <div class="ctrl"> </div>
        <div class="ctrl"> </div>
        <div class="ctrl-fontup" onclick="BodyFontSize(1);">&#8853;</div>
        <div class="ctrl-fontdn" onclick="BodyFontSize(-1);">&#8854;</div>
      </div>
    </div>
    <div class="body" id="body">
      <div class="reader" id="reader">
        <div id="page0" class="page activepage">
        
        </div>
      </div>
      <div class="interface">
        <div class="control left" onclick="SetPage(-1);"></div>
        <div class="control right" onclick="SetPage(1);"></div>
      </div>
    </div>
    <div class="tracker">
    <p> Chapter 
    <span id="n-chnum"></span>
    of
    <span id="n-chtot"></span>
    &emsp;||&emsp;
    Page
    <span id="n-pgnum"></span>
    of
    <span id="n-pgtot"></span>
    
    </p>
    </div>
    <div class="bonus">
      <div class="footer">
        <p>Autononymous &copy; 2024 || Version 0.1.0</p>
      </div>
    </div>
  </div>
</div>


  <script>
    var jStory = "";
var storyLoaded = false;

var ChapterSelected = 1;
var JumpToLastPage = false;

var FontSize = 1.5;

const metaCHNUM = document.getElementById('n-chnum');
const metaCHTOT = document.getElementById('n-chtot');
const metaPGNUM = document.getElementById('n-pgnum');
const metaPGTOT = document.getElementById('n-pgtot');


var READER = document.getElementsByClassName("activepage")[0];

function newEntry(type,title) {
	return JSON.parse(`{ "type":"${type}" , "title":"${title}"}`);
}

const Window = document.getElementById("body");
const Read = document.getElementById("reader");

function isOverflow() {
	let result = Window.getBoundingClientRect().bottom - document.getElementsByClassName('activepage')[0].getBoundingClientRect().bottom;
  return ((result <= 0)?false:true);
}

var ChapterCount = 0;

var jContent = JSON.parse(`[]`);
var TARGET = '';
var Pouch = [];
var currentOffset = 0;

var CurrentPage = 0;

var Pages = 0;

function SetPage(advance) {
	let QueriedPage = CurrentPage+advance;
	if( (QueriedPage >= 0) && (QueriedPage <= Pages) )  {
  	console.log(`Page ${QueriedPage} exists in Chapter ${ChapterSelected}.`)
    READER.style.display = "none";
    READER = document.getElementById(`page${QueriedPage}`);
    READER.style.display = "";
    CurrentPage = QueriedPage;
    metaPGNUM.innerHTML = CurrentPage+1;
  } else {
  	// Jump to next chapter if it exists.
    if (((ChapterSelected + advance) > ChapterCount) || ((ChapterSelected + advance) <= 0)) {
    	console.warn(`Chapter ${ChapterSelected + advance} does not exist.`)
    } else if (advance > 0) {
    	console.info(`Loading next chapter ${ChapterSelected + advance}.`)
      ChapterSelected += advance;
    	loadStory(ChapterSelected)
    } else if (advance < 0) {
    	console.info(`Loading previous chapter ${ChapterSelected + advance}.`)
    	ChapterSelected += advance;
    	loadStory(ChapterSelected);
      JumpToLastPage = true;
    } else {
    	console.warn(`Page ${QueriedPage} does not exist.`)
    }
  	
  }
}

function BodyFontSize(advance) {
  let fontitems = document.getElementsByClassName("Para");
  let currentSize = parseFloat(window.getComputedStyle(fontitems[0], null).getPropertyValue('font-size')) / 16; // Convert to em
  console.log(`Current font size is ${currentSize}em`);
  let newSize = currentSize + (advance * 0.1);
  if (newSize < 0.5) newSize = 0.5; // Minimum font size
  if (newSize > 3) newSize = 3; // Maximum font size
  FontSize = newSize;
  loadStory(ChapterSelected);
  console.log(`Font size changed to ${newSize}em`);
}

async function loadStory(chapter) {
	const response = await fetch("https://raw.githubusercontent.com/autononymous/autononymous.github.io/master/docs/FB00.json")
  const data = await response.text();
  var Lines = [];
  jStory = JSON.parse(data.replaceAll('\n',''));
  console.info(`Story content for ${jStory.Nickname} has been loaded.`)
  
  document.getElementById('body').innerHTML = `    <div class="reader" id="reader">
      <div id="page0" class="page activepage">
      
      </div>
    </div>
    <div class="interface">
      <div class="control left" onclick="SetPage(-1);"></div>
      <div class="control right" onclick="SetPage(1);"></div>
    </div>`
  currentOffset = 0;
  CurrentPage = 0;
  ChapterCount = 0;
  Pages = 0;
  TARGET = '';
  Pouch = [];
  READER = document.getElementsByClassName("activepage")[0];
  
  console.info(`Data has been reset.`)
  
    jStory.Manuscript.forEach(parcel => {
  	let type = parcel.DocType;
  	switch(type) {
    	case "Act":
      	if (parcel.ChapterFull == chapter) {
          jContent.push(newEntry(type,`Act ${parcel.ActNum}`));
          jContent[jContent.length-1].subject = "";
          Pouch.push(`#ACT#`,`Act ${parcel.ActNum}`,`#/#`)
        }
        break;
      case "Chapter":
      	ChapterCount++;
      	if (parcel.ChapterFull == chapter) {
          jContent.push(newEntry(type,parcel.AutoNameFull))
          jContent[jContent.length-1].subject = parcel.GivenName
          Pouch.push(`#CHNUM#`,`Chapter ${parcel.ChapterFull}`,`#/#`)
          Pouch.push(`#SUB#`,`${parcel.GivenName}`,`#/#`)
        }
        break;
      case "Scene":
      	if (parcel.ChapterFull == chapter) {
          jContent.push(newEntry(type,parcel.ScenePart,""))
          jContent[jContent.length-1].subject = parcel.Body.replaceAll('<p>','\n').replaceAll('</p>','').split('\n')
          Pouch.push('#SC#',parcel.ScenePart,'#/#')
          Lines = parcel.Body.replaceAll('<p>','\n').replaceAll('</p>','').split('\n')          
          Lines.forEach( Line => {
          	Pouch.push('#P#')
            Line.split(' ').forEach( Word => {
              Pouch.push((Word!="")?Word:"")
            })   
            Pouch.push('#/#')
          })          
        }
        break;
      default:
      	// ignore
        break;
    }
  })
  
  console.info(`There are ${ChapterCount} available chapters in Project ${jStory.Nickname}.`)
  
  //console.log(Pouch)
  
  var credit = "";
  var lastHTML = "";
  var currentTag = "";
  
  var n_page = 1;
  
  var nScene = 1;
  
  for (let i=0; i<Pouch.length; i++) {
  	credit = Pouch[i];
    lastHTML = READER.innerHTML + " ";
  	switch (credit) {
    	case '#ACT#':
      	currentTag = "ACT";
      	READER.innerHTML += `<h3 class="hAct" id='current'> </h3>`;
        if( isOverflow() == false ) {
        
  				READER.innerHTML = lastHTML;
        }
        TARGET = document.getElementById('current');
        TARGET.id = "";
        break;
      case '#CHNUM#':
      	nScene = 0;
      	currentTag = "CHNUM";
      	READER.innerHTML += `<h3 class="hChap" id='current'> </h3>`;
        if( isOverflow() == false ) {	
  				READER.innerHTML = lastHTML;
        }
        TARGET = document.getElementById('current');
        TARGET.id = "";
        break;
      case '#SUB#':
      	currentTag = "SUB";
      	READER.innerHTML += `<h3 class="hSub" id='current'> </h3>`;
        if( isOverflow() == false ) { 
  				READER.innerHTML = lastHTML;
          READER.className = "page";
          READER.style.display = "none";
          document.getElementById('reader').innerHTML += `<div id="page${n_page++}" class="page activepage"></div>`;
          Pages++;
          READER = document.getElementsByClassName('activepage')[0];
          READER.innerHTML += `<h3 class="hSub" id='current'> </h3>`;
          TARGET = document.getElementById('current');
          TARGET.id = "";
        }
        TARGET = document.getElementById('current');
        TARGET.id = "";
        break;
      case '#SC#':
      	currentTag = "SC";
      	READER.innerHTML += `<h3 class="hScn" id='current'> </h3>`;
        if( isOverflow() == false ) {
  				READER.innerHTML = lastHTML;
          READER.className = "page";
          READER.style.display = "none";
          document.getElementById('reader').innerHTML += `<div id="page${n_page++}" class="page activepage"></div>`;
          Pages++;
          READER = document.getElementsByClassName('activepage')[0];
          READER.innerHTML += `<h3 class="hScn" id='current'> </h3>`;
        }
        TARGET = document.getElementById('current');
        TARGET.id = "";
        break;
      case '#P#':
      	currentTag = "P";
      	READER.innerHTML += `<p class="Para" style="font-size:${FontSize}em;" id='current'> </p>`;
        if( isOverflow() == false ) {
  				READER.innerHTML = lastHTML;
        }
        TARGET = document.getElementById('current');
        TARGET.id = "";
        break;
      case '#/#':
      	TARGET = READER;
        break; 
      default:
      	TARGET.innerHTML += credit + " ";
        if( isOverflow() == false ) {
  				READER.innerHTML = lastHTML;
          READER.className = "page";
          READER.style.display = "none";
          document.getElementById('reader').innerHTML += `<div id="page${n_page++}" class="page activepage"></div>`;
          Pages++;
          READER = document.getElementsByClassName('activepage')[0];
          READER.innerHTML += `<p class="Para" style="font-size:${FontSize}em;" id='current'> </p>`;
          TARGET = document.getElementById('current');
          TARGET.id = "";
          TARGET.innerHTML += credit + " ";
        }
        break;
    }
  }
  console.info("There are " + Pages + " total pages in this chapter.")
  
  READER.className = "page";
  READER.style.display = "none";
  if (JumpToLastPage) {
  	READER = document.getElementById(`page${Pages}`);
    CurrentPage = Pages;
    JumpToLastPage = false;
  } else {
  	READER = document.getElementById('page0');
  }
  
  metaPGNUM.innerHTML = CurrentPage+1;
  metaPGTOT.innerHTML = Pages+1;
  
  metaCHNUM.innerHTML = ChapterSelected;
  metaCHTOT.innerHTML = ChapterCount; 
  
  READER.style.display = "";
  
  
  console.info("Completed loading.")

}
var lastWindowWidth = window.innerWidth;
addEventListener("resize", (event) => { 
  if (window.innerWidth != lastWindowWidth) {
    lastWindowWidth = window.innerWidth;
    loadStory(ChapterSelected)
    console.log(`Window resized to ${lastWindowWidth}px`)
  };
});
loadStory(ChapterSelected);
  </script>
</body>
</html>
